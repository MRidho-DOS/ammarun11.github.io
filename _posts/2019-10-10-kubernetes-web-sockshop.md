---
layout : post
title : "[Kubernetes] Kubernetes Initialize Lab k8s (Part 1)"
categories: [ngoprek, server, cloud, docker, container, orchestration]
---
# بِسْمِ اللَّهِ الرَّحْمَنِ الرَّحِيم
---

Lab ini kita akan ngoprek Kubernetes. Saya disini menggunakan public cloud Azure untuk membangun node yang saya butuhkan untuk ngoprek lab ini.

berikut list node yang saya gunakan :

**pod-master**
* Interface: eth0
* IP Address: 10.0.0.4/24
* Gateway: 10.0.0.1
* DNS Resolver: 10.0.0.1

**pod-worker**
* Interface: eth0
* IP Address: 10.0.0.5/24
* Gateway: 10.0.0.1
* DNS Resolver: 10.0.0.1

**pod-storage**
* Interface: eth0
* IP Address: 10.0.0.6/24
* Gateway: 10.0.0.1
* DNS Resolver: 10.0.0.1



## Kubernetes Clustring Provisioning #####


#### Eksekusi di semua pod ###

## Upgrade paket, instal docker dan k8s Versi (v1.15.4)

```BASH
sudo apt update; sudo apt upgrade -y; sudo apt autoremove -y
sudo apt install -y docker.io; sudo docker version
```

Instal kubectl, kubelet & kubeadm
```BASH
sudo apt install -y apt-transport-https; curl -s https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key add -
```

```BASH
nano kubernetes.list
deb http://apt.kubernetes.io/ kubernetes-xenial main
```
Copy kubernetes.list ke repo list
```BASH
sudo mv kubernetes.list /etc/apt/sources.list.d/kubernetes.list
sudo apt update; sudo apt install -y kubectl=1.15.4-00 kubelet=1.15.4-00 kubeadm=1.15.4-00
sudo apt-mark hold kubelet kubeadm kubectl
```
Cek versi
```BASH
root@pod-master:~# kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"15", GitVersion
:"v1.15.4", GitCommit:"67d2fcf276fcd9cf743ad4be9a9ef5828adc082f", GitTreeState:"clean", BuildDate:"2019-09-18T14:48:18Z", GoVersion:"go1.12.9", Compiler:"gc", Platform:"linux/amd64"}
```


## Eksekusi di pod master #####

Inisialisasi Master (verifikasi dan matikan swap lebih dulu)
```BASH
swapon -s
sudo swapoff -a
sudo kubeadm init --pod-network-cidr=10.244.3.0/16
Membuat secret sebelum itu kita harus menyalakan docker swarm
```
Salin konfigurasi admin kubernetes
```BASH
mkdir -p $HOME/.kube
sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config
sudo chown $(id -u):$(id -g) $HOME/.kube/config
```
Instal POD Network Flannel
```BASH
wget https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml

kubectl apply -f kube-flannel.yml
kubectl get pods --all-namespaces --watch
```
```BASH
root@pod-master :~# kubectl get pods --all-namespaces --watch
NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE
kube-system   coredns-5c98db65d4-ncfbn             1/1     Running   0          5m45s
kube-system   coredns-5c98db65d4-xfzmg             1/1     Running   0          5m45s
kube-system   etcd-pod-master                      1/1     Running   0          4m47s
kube-system   kube-apiserver-pod-master            1/1     Running   0          4m58s
kube-system   kube-controller-manager-pod-master   1/1     Running   0          4m58s
kube-system   kube-flannel-ds-amd64-jdf4f          1/1     Running   0          3m55s
kube-system   kube-proxy-kjpwz                     1/1     Running   0          5m45s
kube-system   kube-scheduler-pod-master            1/1     Running   0          4m59s
```

Verifikasi config dan cluster
```BASH
kubectl config view
kubectl cluster-info
```
```BASH
root@pod-master :~# kubectl config view
apiVersion: v1
clusters:
- cluster:
    certificate-authority-data: DATA+OMITTED
    server: https://10.0.0.4:6443
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: kubernetes-admin
  name: kubernetes-admin@kubernetes
current-context: kubernetes-admin@kubernetes
kind: Config
preferences: {}
users:
- name: kubernetes-admin
  user:
    client-certificate-data: REDACTED
    client-key-data: REDACTED

root@pod-master :~# kubectl cluster-info
Kubernetes master is running at https://10.0.0.4:6443
KubeDNS is running at https://10.0.0.4:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy
To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

Tampilkan Token dan token-ca-cert-hash 

```BASH
sudo kubeadm token list
sudo openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl  rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
```

```BASH
root@pod-master :~# kubeadm token list

TOKEN                     TTL       EXPIRES                USAGES                   DESCRIPTION                                                EXTRA GROUPS
ihk6ha.vlih4iuykm0y68i3   23h       2019-10-11T12:51:38Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token

root@pod-master :~# openssl x509 -pubkey -in /etc/kubernetes/pki/ca.crt | openssl rsa -pubin -outform der 2>/dev/null | openssl dgst -sha256 -hex | sed 's/^.* //'
de9c723b4b3d10e54cbb4cbc55d9abd007fa9edaf0076577827b5d33b59e79c4
```

* token master `ihk6ha.vlih4iuykm0y68i3`
* TOKEN-CA-CERT-HASH `de9c723b4b3d10e54cbb4cbc55d9abd007fa9edaf0076577827b5d33b59e79c4`

## Ekseskusi di pod-worker

Join Node Worker ke Master (verifikasi dan matikan swap lebih dulu)
```BASH
swapon -s
sudo swapoff -a
sudo kubeadm join --token [TOKEN] [NODE-MASTER]:6443 --discovery-token-ca-cert-hash sha256:[TOKEN-CA-CERT-HASH]
```

```BASH
root@pod-worker:~# sudo kubeadm join --token ihk6ha.v
lih4iuykm0y68i3 pod-master:6443 --discovery-token-ca-cert-hash sha256:de9c723b4b3d10e54cbb4cbc55d9abd007fa9edaf0076577827b5d33b59e79c
```
## Eksekusi di pod master #####

verifikasi nodes 
```BASH
kubectl get nodes
```

```BASH
root@pod-master :~# kubectl get nodes 
NAME          STATUS   ROLES    AGE   VERSION
pod-master    Ready    master   31m   v1.15.4
pod-worker    Ready    <none>   15m   v1.15.4
```


```BASH
docker swarm init
printf "This is a secret" | docker secret create my_secret_data -
```
```BAS
root@pod0:~/latihan/my_app# docker swarm init
Swarm initialized: current node (4juunpj0nqynqwa4wy5ayxii4) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-3myyev16e7p7jufe8wnxjvva2bfpdej8vn2i0qo4trg1oqtpp6-5w45qka34re1y6fu6p4pn3e0a 10.1.40.12:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
root@pod0:~/latihan/my_app# printf "This is a secret" | docker secret create my_secret_data -
naq6d6a8ol179z4rivaqylvl0
```
Membuat service redis dan mengizinkan akses secret my_secret_data & Verfikasi

```BASH
docker service  create --name redis --secret my_secret_data redis:alpine
docker service ps redis
```
```BASH
root@pod0:~/latihan/my_app# docker service  create --name redis --secret my_secret_data redis:alpine

lkilpy5cks3j34qdjiw85pmsm
overall progress: 1 out of 1 tasks 
1/1: running   [==================================================>] 
verify: Service converged 
root@pod0:~/latihan/my_app# docker service ps redis
ID                  NAME                IMAGE               NODE                DESIRED STATE       CURRENT STATE           ERROR               PORTS
lvot7d1uge6p        redis.1             redis:alpine        pod0                Running             Running 2 minutes ago                       
```

Membaca content di dalam container
```BASH
docker ps --filter name=redis -q
docker container exec $(docker ps --filter name=redis -q) ls -l /run/secrets
docker container exec $(docker ps --filter name=redis -q) cat /run/secrets/my_secret_data
```

```BASH
root@pod0:~/latihan/my_app# docker ps --filter name=redis -q
43963304e729
root@pod0:~/latihan/my_app# docker container exec $(docker ps --filter name=redis -q) ls -l /run/secrets
total 4
-r--r--r--    1 root     root            16 Oct  7 13:30 my_secret_data
root@pod0:~/latihan/my_app# docker container exec $(docker ps --filter name=redis -q) cat /run/secrets/my_secret_data
This is a secret
```

untuk Verifikasi secret tidak ada di image hasil commit container
```BASH
docker commit $(docker ps --filter name=redis -q) committed_redis
docker run --rm -it committed_redis cat /run/secrets/my_secret_data
```

```BASH
root@pod0:~/latihan/my_app# docker commit $(docker ps --filter name=redis -q) committed_redis
sha256:6cbc73dccdf4b2f1a7a69615bdca8571357f9c889c99730da91c52ebd2d1ccbb
root@pod0:~/latihan/my_app# docker run --rm -it committed_redis cat /run/secrets/my_secret_data
```

Mencoba hapus secret (pastikan gagal karena masih ada service redis dan memiliki akses ke secret)
```BASH
docker secret ls
docker secret rm my_secret_data
```

Untuk menghapus izin akses secret pada service redis dengan
```BASH
docker service update --secret-rm my_secret_data redis
```

Verifikasi secret tidak ada di dalam container service redis bisa dengan :
```BASH
root@pod0:~/latihan/my_app# docker container exec $(docker ps --filter name=redis -q) cat /run/secrets/my_secret_data
cat: can't open '/run/secrets/my_secret_data': No such file or directory
```

Dan juga kita bisa menghapus secret dan service redis :
```BASH
docker service rm redis
docker secret rm my_secret_data
```
```BASH
root@pod0:~/latihan/my_app# docker service rm redis
redis
root@pod0:~/latihan/my_app# docker secret rm my_secret_data
my_secret_data
```
